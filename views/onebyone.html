{{template "_head.html" .}}

<body ontouchstart="" >
<div style="width: 100%;height: 45px;background-color: #efeff4;text-align: center;border-bottom:1px solid #ddd">
    <a href="/" style=""><span style="font-size: 32px;float: left;margin-left: 20px;"> < </span></a>
    <span style="font-size: 25px;margin-right: 20px;" > {{.you_name}} </span>
</div>


<div id="show"></div>

<form style="">
    <div class="weui-cells weui-cells_form" style="">
      <div class="weui-cell">
        <div class="weui-cell__bd">
          <textarea class="weui-textarea" id="msg" placeholder="请输入文本" rows="2"></textarea>
          <div class="weui-textarea-counter"><span>0</span>/200</div>
        </div>
      </div>
    </div>
    <div class="weui-flex" style="margin-top:21px;">
          <div class="weui-flex__item" >
              <a id="form" class="weui-btn weui-btn_plain-default" style="height: 38px;width: 96%;">发送</a>
          </div>
      </div>
</form>

{{template "_js.html" .}}
<script type="text/javascript">

var history_msg = "{{.history_msg}}"
var myname = "{{.my_name}}";
var youname = "{{.you_name}}";


function History(){
    var history_msg_obj = JSON.parse(history_msg);
    for (var i = 0; i < history_msg_obj.length; i++){
        var msg_obj = JSON.parse(history_msg_obj[i]);
        if (myname == msg_obj["name"]){
            MyShow1vs1(msg_obj["data"], msg_obj["time"], msg_obj["head_img"]);
        }else{
            YouShow1vs1(msg_obj["data"], msg_obj["time"], msg_obj["head_img"]);
        }
    }
}


window.onload = function () {

    History();
    var conn;
    var msg = document.getElementById("msg");

     $("#form").click(function (){
        if (!conn) {
            return false;
        }
        if (!msg.value) {
            return false;
        }
        conn.send(msg.value);
        msg.value = "";
        return false;
    });
    
    if (window["WebSocket"]) {
        var room = "{{.room_name}}";
        conn = new WebSocket("ws://" + document.location.host + "/ws/onebyone?room="+room+"&myname="+myname+"&youname="+youname);
        conn.onclose = function (evt) {
            appendErr("<b>Connection closed. 连接断开</b>");
        };
        conn.onmessage = function (evt) {
            var messages = evt.data.split('\n');
            var obj = JSON.parse(messages);

            if (myname == obj["name"]){
                MyShow1vs1(obj["data"], obj["time"], obj["head_img"]);
            }else{
                YouShow1vs1(obj["data"], obj["time"], obj["head_img"]);
            }
        };
    } else {
        appendErr("<b>你当前使用的浏览器不支持即使聊天，请更新或更换浏览器.</b>");
    }
};
</script>


</body>
</html>
